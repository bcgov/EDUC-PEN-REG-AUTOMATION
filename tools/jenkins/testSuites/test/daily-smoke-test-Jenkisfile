#!/usr/bin/env groovy
pipeline {
  agent any
  tools {nodejs "latest"}
  environment {
    LOCAL_JSON = ''
    extJSHelper = ''
    OWNER = 'bcgov'
    TESTS_REPO_NAME = 'educ-pen-reg-automation'
  }
  stages {
    stage('Initialize network') {
      steps {
          script {
            sh(script: 'oc process -f https://raw.githubusercontent.com/bcgov/EDUC-INFRA-COMMON/master/openshift/common-ns/ocp4/knp/common-ns-policies-e2e.yaml -p COMMON_NAMESPACE_PREFIX=8878b4 -p ENVIRONMENT=tools | oc -n 75e61b-test create -f -', returnStdout: true)
          }
      }
    }
    stage('Initialize') {
      steps {
        script {
          sh "wget -O - https://raw.githubusercontent.com/bcgov/EDUC-INFRA-COMMON/master/openshift/common-deployment/deployHelpers.js > deployHelpers.js"
          extJSHelper = evaluate readFile('deployHelpers.js')
        }
        dir('frontend') {
          script {
            LOCAL_JSON = sh(script: 'oc -n 8878b4-test -o json get secret test-cafe-config | sed -n \'s/.*"local.json": "\\(.*\\)"/\\1/p\' | base64 --decode', returnStdout: true).trim()
            writeFile file: '/var/lib/jenkins/jobs/TEST/jobs/TestCafeWorkflows/jobs/TestSuites/jobs/daily-smoke-test/workspace/frontend/tests/e2e/config/index.js', text: LOCAL_JSON
          }
        }
      }
    }
    stage('get and delete pen request one') {
      steps {
        dir('frontend') {
          sh 'npm install'
          sh 'npm run getAndDeletePenRequestData'
        }
      }
    }    
    stage('staff request more info and reject on pen') {
      steps {
        script {
          try{
          TOKEN = sh( script: "oc -n 8878b4-test -o json get secret github-actions-token | sed -n 's/.*\"token\": \"\\(.*\\)\"/\\1/p' | base64 --decode", returnStdout: true);
          extJSHelper.triggerWorkflow(TOKEN, 'staff-request-more-info-and-reject-pen-request-test-environment')
          extJSHelper.waitForWorkflowRunComplete(TOKEN)
          }
          catch(err){
            currentBuild.result = 'FAILURE'
            echo "Error detected, Continue to the next step"
          }          
        }
      }
    }
    stage('get and delete pen request two') {
      steps {
        dir('frontend') {
          sh 'npm run getAndDeletePenRequestData'
        }
      }
    }
    stage('get and delete ump request one') {
      steps {
        dir('frontend') {
          sh 'npm run getAndDeleteUmpRequestData'
        }
      }
    }    
    stage('staff request more info and reject on ump') {
      steps {
        script {
          try{
          TOKEN = sh( script: "oc -n 8878b4-test -o json get secret github-actions-token | sed -n 's/.*\"token\": \"\\(.*\\)\"/\\1/p' | base64 --decode", returnStdout: true);
          extJSHelper.triggerWorkflow(TOKEN, 'staff-request-more-info-and-reject-ump-request-test-environment')
          extJSHelper.waitForWorkflowRunComplete(TOKEN)
          }
          catch(err){
            currentBuild.result = 'FAILURE'
            echo "Error detected, Continue to the next step"
          }          
        }
      }
    }
    stage('get and delete ump request two') {
      steps {
        dir('frontend') {
          sh 'npm run getAndDeleteUmpRequestData'
        }
      }
    }
    stage('get and delete pen request three') {
      steps {
        dir('frontend') {
          sh 'npm run getAndDeletePenRequestData'
        }
      }
    }
    stage('get and delete Bceid from KC') {
      steps {
        dir('frontend') {
          sh 'npm run deleteBceidFromKC'
        }
      }
    }
    stage('get and delete IDIR from KC') {
      steps {
        dir('frontend') {
          sh 'npm run deleteIDIRFromKC'
        }
      }
    }
    stage('Run unauthorized IDIR test') {
      steps {
        script {
          try{
          TOKEN = sh( script: "oc -n 8878b4-test -o json get secret github-actions-token | sed -n 's/.*\"token\": \"\\(.*\\)\"/\\1/p' | base64 --decode", returnStdout: true);
          extJSHelper.triggerWorkflow(TOKEN, 'unauthorized-access-test-environment')
          extJSHelper.waitForWorkflowRunComplete(TOKEN)
          }
          catch(err){
            currentBuild.result = 'FAILURE'
            echo "Error detected, Continue to the next step"
          }          
        }
      }
    }
    stage('add admin roles to IDIR') {
      steps {
        dir('frontend') {
          sh 'npm run updateIDIRRolesInKC'
        }
      }
    }                
    stage('staff issue pen') {
      steps {
        script {
          try{
          TOKEN = sh( script: "oc -n 8878b4-test -o json get secret github-actions-token | sed -n 's/.*\"token\": \"\\(.*\\)\"/\\1/p' | base64 --decode", returnStdout: true);
          extJSHelper.triggerWorkflow(TOKEN, 'staff-issue-pen-test-environment')
          extJSHelper.waitForWorkflowRunComplete(TOKEN)
          }
          catch(err){
            currentBuild.result = 'FAILURE'
            echo "Error detected, Continue to the next step"
          }          
        }
      }
    }
    stage('Insert and Update pen request data') {
      steps {
        dir('frontend') {
          sh 'npm run insertAndUpdatePenRequestData'
        }
      }
    }
    stage('staff verify prior pen requests displayed') {
      steps {
        script {
          try{
          TOKEN = sh( script: "oc -n 8878b4-test -o json get secret github-actions-token | sed -n 's/.*\"token\": \"\\(.*\\)\"/\\1/p' | base64 --decode", returnStdout: true);
          extJSHelper.triggerWorkflow(TOKEN, 'staff-veify-prior-pen-requests-displayed-test-environment')
          extJSHelper.waitForWorkflowRunComplete(TOKEN)
          }
          catch(err){
            currentBuild.result = 'FAILURE'
            echo "Error detected, Continue to the next step"
          }          
        }
      }
    }
    stage('get and update pen request data to past') {
      steps {
        dir('frontend') {
          sh 'npm run getAndUpdatePenRequestDataToPast'
        }
      }
    }
    stage('staff verify prior pen requests not displayed') {
      steps {
        script {
          try{
          TOKEN = sh( script: "oc -n 8878b4-test -o json get secret github-actions-token | sed -n 's/.*\"token\": \"\\(.*\\)\"/\\1/p' | base64 --decode", returnStdout: true);
          extJSHelper.triggerWorkflow(TOKEN, 'staff-veify-prior-pen-requests-not-displayed-test-environment')
          extJSHelper.waitForWorkflowRunComplete(TOKEN)
          }
          catch(err){
            currentBuild.result = 'FAILURE'
            echo "Error detected, Continue to the next step"
          }          
        }
      }
    }   
    stage('get and delete pen request four') {
      steps {
        dir('frontend') {
          sh 'npm run getAndDeletePenRequestData'
        }
      }
    }
    stage('get and delete pen request five') {
      steps {
        dir('frontend') {
          sh 'npm run getAndDeletePenRequestData'
        }
      }
    }
    stage('Tear-down network') {
      steps {
          script {
            sh(script: 'oc -n 75e61b-test delete networkpolicy -l name=allow-traffic-from-jenkins-pen-tools', returnStdout: true)
          }
      }
    }                    
  }
}